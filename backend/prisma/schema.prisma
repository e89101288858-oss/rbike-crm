generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  FRANCHISEE
  MANAGER
  MECHANIC
}

enum BikeStatus {
  AVAILABLE
  RENTED
  MAINTENANCE
  BLOCKED
  LOST
}

enum RentalStatus {
  ACTIVE
  CLOSED
  CANCELED
}

enum PaymentStatus {
  PLANNED
  PAID
}

enum PaymentKind {
  WEEKLY_RENT
  MANUAL
}

enum DocumentType {
  PASSPORT_PHOTO
  CONTRACT
  ACT
}

enum RentalChangeType {
  EXTEND
  SHORTEN
  CLOSE
}

enum RegistrationRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BatteryStatus {
  AVAILABLE
  RENTED
  MAINTENANCE
  LOST
}

model User {
  id           String       @id @default(uuid())
  email        String       @unique
  passwordHash String
  role         UserRole
  franchiseeId String?
  franchisee   Franchisee?  @relation(fields: [franchiseeId], references: [id])
  userTenants  UserTenant[]
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())

  // обратные связи для createdBy / markedBy
  createdRentals       Rental[]       @relation("RentalCreatedBy")
  createdRentalChanges RentalChange[] @relation("RentalChangeCreatedBy")
  markedPayments       Payment[]      @relation("PaymentMarkedBy")
  createdRepairs       Repair[]       @relation("RepairCreatedBy")
  createdDocuments     Document[]     @relation("DocumentCreatedBy")
  auditLogs            AuditLog[]
  reviewedRegistrationRequests RegistrationRequest[] @relation("RegistrationReviewedBy")
}

model Franchisee {
  id             String   @id @default(uuid())
  name           String
  companyName    String?
  signerFullName String?
  bankDetails    String?
  tenants        Tenant[]
  users          User[]
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
}

model Tenant {
  id             String     @id @default(uuid())
  name           String
  franchiseeId   String
  franchisee     Franchisee @relation(fields: [franchiseeId], references: [id])
  dailyRateRub   Float      @default(500)
  minRentalDays  Int        @default(7)

  userTenants UserTenant[]

  bikes         Bike[]
  batteries     Battery[]
  clients       Client[]
  rentals       Rental[]
  rentalBatteries RentalBattery[]
  rentalChanges RentalChange[]
  payments      Payment[]
  repairs       Repair[]
  documents     Document[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model UserTenant {
  userId   String
  tenantId String
  user     User   @relation(fields: [userId], references: [id])
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  @@id([userId, tenantId])
}

model Bike {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  code             String
  model            String?
  frameNumber      String?
  motorWheelNumber String?
  simCardNumber    String?
  status           BikeStatus @default(AVAILABLE)
  repairReason     String?
  repairEndDate    DateTime?
  isActive         Boolean    @default(true)

  rentals Rental[]
  batteries Battery[]
  repairs Repair[]

  createdAt DateTime @default(now())

  @@unique([tenantId, code])
}

model Battery {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  bikeId String?
  bike   Bike? @relation(fields: [bikeId], references: [id])

  code         String
  serialNumber String?
  status       BatteryStatus @default(AVAILABLE)
  notes        String?
  isActive     Boolean       @default(true)

  rentals   RentalBattery[]
  createdAt DateTime @default(now())

  @@unique([tenantId, code])
  @@index([tenantId, bikeId])
}

model RentalBattery {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  rentalId  String
  rental    Rental   @relation(fields: [rentalId], references: [id])
  batteryId String
  battery   Battery  @relation(fields: [batteryId], references: [id])
  createdAt DateTime @default(now())

  @@unique([rentalId, batteryId])
  @@index([tenantId, rentalId])
  @@index([tenantId, batteryId])
}

model Client {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  fullName       String
  phone          String?
  address        String?
  passportSeries        String?
  passportNumber        String?
  emergencyContactPhone String?
  notes                 String?
  isActive              Boolean @default(true)

  rentals   Rental[]
  documents Document[]

  createdAt DateTime @default(now())
}

model Rental {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  bikeId String
  bike   Bike   @relation(fields: [bikeId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  startDate      DateTime
  plannedEndDate DateTime
  actualEndDate  DateTime?
  weeklyRateRub  Float    @default(0)

  status RentalStatus @default(ACTIVE)

  changes  RentalChange[]
  payments Payment[]
  batteries RentalBattery[]
  documents Document[]

  createdById String?
  createdBy   User?   @relation("RentalCreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())

  @@index([tenantId, status])
  @@index([bikeId])
  @@index([clientId])
}

model RentalChange {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  rentalId String
  rental   Rental @relation(fields: [rentalId], references: [id])

  type      RentalChangeType
  daysDelta Int
  reason    String?

  createdById String?
  createdBy   User?   @relation("RentalChangeCreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())

  @@index([rentalId])
}

model Payment {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  rentalId String
  rental   Rental @relation(fields: [rentalId], references: [id])

  amount      Float
  kind        PaymentKind   @default(WEEKLY_RENT)
  status      PaymentStatus @default(PLANNED)
  dueAt       DateTime?
  periodStart DateTime?
  periodEnd   DateTime?

  markedById String?
  markedBy   User?   @relation("PaymentMarkedBy", fields: [markedById], references: [id])

  paidAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([tenantId, status])
  @@index([tenantId, dueAt])
  @@unique([rentalId, kind, periodStart])
}

model Repair {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  bikeId String
  bike   Bike   @relation(fields: [bikeId], references: [id])

  description String
  isClosed    Boolean @default(false)

  createdById String?
  createdBy   User?   @relation("RepairCreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
}

model Document {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  rentalId String?
  rental   Rental? @relation(fields: [rentalId], references: [id])

  type     DocumentType
  filePath String // локальный путь или относительный путь

  createdById String?
  createdBy   User?   @relation("DocumentCreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())

  @@index([tenantId, type])
  @@index([clientId])
  @@index([rentalId])
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  action     String
  targetType String
  targetId   String?
  details    Json?
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([userId])
}

model RegistrationRequest {
  id           String                    @id @default(uuid())
  email        String                    @unique
  passwordHash String
  fullName     String?
  phone        String?
  status       RegistrationRequestStatus @default(PENDING)
  reviewedById String?
  reviewedBy   User?                     @relation("RegistrationReviewedBy", fields: [reviewedById], references: [id])
  createdAt    DateTime                  @default(now())
  reviewedAt   DateTime?

  @@index([status, createdAt])
}
